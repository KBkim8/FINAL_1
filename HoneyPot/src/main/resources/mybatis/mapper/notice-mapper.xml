<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="notice">
	
	<!-- 공지사항 목록 조회 -->
	<select id="getNoticeList" resultType="com.hp.app.notice.vo.NoticeVo">
		WITH NOTICE_LIST AS
		(
			SELECT 
				N.NO AS NO
				,N.NOTICE_CNO AS NOTICE_CNO
				,C.NAME AS NOTICE_CNAME
				,('[' || C.NAME || ']' || ' ' || N.TITLE) AS FULLNAME
				,N.WRITER_NO AS WRITER_NO
				,A.NAME AS WRITER_NAME
				,TITLE
				,CONTENT
				,ENROLL_DATE
				,MODIFY_DATE
				,N.STATUS AS STATUS
				,HIT
				,IMPORTANT_YN
			FROM
				NOTICE N
				JOIN NOTICE_CATEGORY C ON N.NOTICE_CNO = C.NO
				JOIN ADMIN A ON N.WRITER_NO = A.NO
			WHERE N.STATUS = 'Y'
			<if test="searchType == 'title' and searchValue != null and searchValue != ''">
				AND ('[' || C.NAME || ']' || ' ' || N.TITLE) LIKE ('%${searchValue}%')
			</if>
			<if test="searchType == 'content' and searchValue != null and searchValue != ''">
				AND N.CONTENT LIKE ('%${searchValue}%')
			</if>
			<if test="searchType == 'writer' and searchValue != null and searchValue != ''">
				AND A.NAME LIKE ('%${searchValue}%')
			</if>
		),
		
		IMPORTANT_NOTICE AS
		(
			SELECT * FROM NOTICE_LIST WHERE IMPORTANT_YN = 'Y'
			<choose>
				<when test="sortType == 'date'">
					ORDER BY ENROLL_DATE DESC
				</when>
				<when test="sortType == 'hit'">
					ORDER BY HIT DESC, NO DESC
				</when>
				<otherwise>
					ORDER BY NO DESC
				</otherwise>
			</choose>
		),
		
		ALL_NOTICE AS 
		(
			SELECT * FROM NOTICE_LIST
			<choose>
				<when test="sortType == 'date'">
					ORDER BY ENROLL_DATE DESC
				</when>
				<when test="sortType == 'hit'">
					ORDER BY HIT DESC, NO DESC
				</when>
				<otherwise>
					ORDER BY NO DESC
				</otherwise>
			</choose>
		)
		
		SELECT * FROM IMPORTANT_NOTICE
		UNION ALL
		SELECT * FROM ALL_NOTICE
	</select>


	<!-- 공지사항 개수 -->
	<select id="countNotice" resultType="int">
		WITH NOTICE_LIST AS
		(
			SELECT 
				N.NO AS NO
				,N.NOTICE_CNO AS NOTICE_CNO
				,C.NAME AS NOTICE_CNAME
				,('[' || C.NAME || ']' || ' ' || N.TITLE) AS FULLNAME
				,N.WRITER_NO AS WRITER_NO
				,A.NAME AS WRITER_NAME
				,TITLE
				,CONTENT
				,ENROLL_DATE
				,MODIFY_DATE
				,N.STATUS AS STATUS
				,HIT
				,IMPORTANT_YN
			FROM
				NOTICE N
				JOIN NOTICE_CATEGORY C ON N.NOTICE_CNO = C.NO
				JOIN ADMIN A ON N.WRITER_NO = A.NO
			WHERE N.STATUS = 'Y'
			<if test="searchType == 'title' and searchValue != null and searchValue != ''">
				AND ('[' || C.NAME || ']' || ' ' || N.TITLE) LIKE ('%${searchValue}%')
			</if>
			<if test="searchType == 'content' and searchValue != null and searchValue != ''">
				AND N.CONTENT LIKE ('%${searchValue}%')
			</if>
			<if test="searchType == 'writer' and searchValue != null and searchValue != ''">
				AND A.NAME LIKE ('%${searchValue}%')
			</if>
		),
		
		IMPORTANT_NOTICE AS
		(
			SELECT * FROM NOTICE_LIST WHERE IMPORTANT_YN = 'Y'
		),
		
		ALL_NOTICE AS 
		(
			SELECT * FROM NOTICE_LIST
		)
		
		SELECT COUNT(*)
		FROM
		(
			SELECT * FROM IMPORTANT_NOTICE
			UNION ALL
			SELECT * FROM ALL_NOTICE
		)
		
		
<!-- 		SELECT COUNT(N.NO)
		FROM
			NOTICE N
			JOIN NOTICE_CATEGORY C ON N.NOTICE_CNO = C.NO
			JOIN ADMIN A ON N.WRITER_NO = A.NO
		WHERE N.STATUS ='Y'
		<if test="searchType == 'title' and searchValue != null and searchValue != ''">
			AND ('[' || C.NAME || ']' || ' ' || N.TITLE) LIKE ('%${searchValue}%')
		</if>
		<if test="searchType == 'content' and searchValue != null and searchValue != ''">
			AND N.CONTENT LIKE ('%${searchValue}%')
		</if>
		<if test="searchType == 'writer' and searchValue != null and searchValue != ''">
			AND A.NAME LIKE ('%${searchValue}%')
		</if> -->
	</select>
	
	
	<!-- 공지사항 상세조회 -->
	<select id="viewDetail" resultType="com.hp.app.notice.vo.NoticeVo">
		SELECT 
			N.NO AS NO
			,N.NOTICE_CNO AS NOTICE_CNO
			,C.NAME AS NOTICE_CNAME
			,('[' || C.NAME || ']' || ' ' || N.TITLE) AS FULLNAME
			,N.WRITER_NO AS WRITER_NO
			,A.NAME AS WRITER_NAME
			,TITLE
			,CONTENT
			,ENROLL_DATE
			,MODIFY_DATE
			,N.STATUS AS STATUS
			,HIT
			,IMPORTANT_YN
		FROM
			NOTICE N
			JOIN NOTICE_CATEGORY C ON N.NOTICE_CNO = C.NO
			JOIN ADMIN A ON N.WRITER_NO = A.NO
		WHERE N.STATUS = 'Y'
		AND N.NO = #{no}
	</select>
	
	
	<!-- 조회수 증가 -->
	<update id="plusHit">
		UPDATE NOTICE SET HIT = HIT +1
		WHERE NO = #{no} AND STATUS = 'Y'
	</update>
	
	
	<!-- 글 작성 -->
 	<insert id="write">
		INSERT INTO NOTICE (
			NO
		    ,NOTICE_CNO
		    ,WRITER_NO
		    ,TITLE
		    ,CONTENT
		    ,IMPORTANT_YN
		    )
		VALUES (
		    SEQ_NOTICE_NO.NEXTVAL
		    ,#{noticeCno}
		    ,#{writerNo}
		    ,#{title}
		    ,#{content}
		    ,#{importantYn}
		    )
	</insert>
	
	
	<!-- 글 수정 -->
	<update id="edit">
		UPDATE NOTICE
			SET
				NOTICE_CNO = #{noticeCno}
			    ,TITLE = #{title}
			    ,CONTENT = #{content}
			    ,MODIFY_DATE = SYSDATE
			    ,IMPORTANT_YN = #{importantYn}
			WHERE NO = #{no} AND WRITER_NO = #{writerNo} AND STATUS = 'Y'
	</update>
	
	
	<!-- 카테고리 조회 -->
	<select id="getCategory" resultType="com.hp.app.notice.vo.NoticeCategoryVo">
		SELECT NO, NAME
		FROM NOTICE_CATEGORY
	</select>
	
	
	<!-- 글 삭제 -->
	<delete id="delete">
		UPDATE NOTICE 
			SET STATUS = 'N'
		WHERE NO = #{no} AND WRITER_NO = #{writerNo} AND STATUS = 'Y'
	</delete>
	
	
	<!-- 투표생성 -->
	<insert id="makeVote">
		INSERT INTO VOTE (
			NOTICE_NO
			,TITLE
			,END_DATE
			)
		VALUES (
			SEQ_NOTICE_NO.CURRVAL
			,#{voteTitle}
			,TO_TIMESTAMP(#{endDate}, 'YYYY-MM-DD')
			)
	</insert>
	
	
	<!-- 투표항목 삽입 -->
	<insert id="insertVoteArticle">
		INSERT ALL
		
		<foreach collection="list" item="item">
			INTO VOTE_CANDIDATE (
				NO
				,NOTICE_NO
				,NAME
			) 
			VALUES (
				#{item.no}
				,SEQ_NOTICE_NO.CURRVAL
				,#{item.name}
			)
		</foreach>
		
		SELECT * FROM DUAL
	</insert>
	

</mapper>